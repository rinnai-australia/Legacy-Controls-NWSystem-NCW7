//*********************************************************************************************************************************************************************************
// stm32f10x_it.c
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * Release Information.
 *---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 *
 * Version:		N-C7  	   - v090
 * Date:		01/10/2020
 * Modifier:  	Emilio R. La Greca
 *
 * Original release.
 *
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

#include		<com_defn.h>
#include 		<app_main.h>
#include 		<i2ccomif.h>
#include		<usbserif.h>
#include 		<twbcomif.h>
#include		<rtmclkif.h>
#include		<tftdspif.h>
#include 		<FT800_deviceif.h>

//*********************************************************************************************************************************************************************************
// MODULE
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// CONSTANTS
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// VARIABLES
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// SAVED VALUES
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// TIMING
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// FUNCTION DECLARES
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//*********************************************************************************************************************************************************************************


//*********************************************************************************************************************************************************************************
// APPLICATION
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// VARIABLES
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// FUNCTION DEFINITIONS
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:  This function handles NMI exception.
 * @param:  None.
 * @retval: None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void 		NMI_Handler(void)
{
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:  This function handles Hard Fault exception.
 * @param:  None.
 * @retval: None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void 		HardFault_Handler(void)
{
  /* Go to infinite loop when Hard Fault exception occurs */
  while (1)
  {
  }
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:  This function handles Memory Manage exception.
 * @param:  None.
 * @retval: None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void 		MemManage_Handler(void)
{
  /* Go to infinite loop when Memory Manage exception occurs */
  while (1)
  {
  }
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:  This function handles Bus Fault exception.
 * @param:  None.
 * @retval: None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void 		BusFault_Handler(void)
{
  /* Go to infinite loop when Bus Fault exception occurs */
  while (1)
  {
  }
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:  This function handles Usage Fault exception.
 * @param:  None.
 * @retval: None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void 		UsageFault_Handler(void)
{
  /* Go to infinite loop when Usage Fault exception occurs */
  while (1)
  {
  }
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:  This function handles SVCall exception.
 * @param:  None.
 * @retval: None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void 		SVC_Handler(void)
{
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief   This function handles Debug Monitor exception.
 * @param  	None.
 * @retval 	None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void 		DebugMon_Handler(void)
{
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:  This function handles PendSVC exception.
 * @param:  None.
 * @retval: None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void 		PendSV_Handler(void)
{
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:  This function handles SysTick Handler.  It is configured to fire every 10ms upon which 10ms actions are processed.
 * @param:  None.
 * @retval: None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void 		SysTick_Handler(void)
{
	APP_MAIN__Update10ms();
	return;
}
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//	STM32F1xx Application Specific Peripherals Interrupt Handlers
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:  1ms interval timer.
 * @param:  None.
 * @retval: None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void		TIM6_IRQHandler(void)
{
	TIM6->SR &= ~TIM_SR_UIF;

	APP_MAIN__Update01ms();
	return;
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:  This function handles the RTC interrupts that are enabled.  For NC5 this involves updating the time as one second elapses.
 * @param:  None.
 * @retval: None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void		RTC_IRQHandler(void)
{
	// Reaet pending interrupt
	RTC->CRL &= ~RTC_CRL_SECF;
	// Flag that one second has elapsed -> See RTMCLKIF module
	RTMCLKIF__UpdateRTCControlAfterOneSecondInterruptElapsed();

	return;
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief   This function handles the SPI1 interrupt for data transfer with the FT800 device.
 * @param  	None.
 * @retval 	None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void 		SPI1_IRQHandler(void)
{
	uint8_t		ucValue;

	// Hanging in while loop not a good idea - does not leave time for other processes to execute in time.
	// All that is needed is RXNE interrupt because if byte shifted in then byte must have been shifted out, emilio 27-10-15
	if ( (SPI1->SR & SPI_SR_RXNE) != 0 )
	{
		ucValue = SPI1->DR;

		if ( FT800_DEVICEIF__bUpdateTxAfterRx( &ucValue ) )
		{
			SPI1->DR = ucValue;
		}
		else
		{
			SPI1->CR2 &= ~SPI_SR_RXNE;
		}
	}

	return;
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief   USART1 Interrupt - USB Serial Comms Interface updated using the following function:
 *
 * 					- USBSERIF_UpdateAfterByteRxed()
 * 					- USBSERIF_UpdateAfterByteRxed()
 * 					- USBSERIF_UpdateAfterErrorDetected()
 *
 * @param  	None.
 * @retval 	None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void		USART1_IRQHandler(void)
{
	uint32_t	ulRxStatus;

	ulRxStatus = USART1->SR;											// Get USART Status

	if ( ( ulRxStatus & USART_SR_RXNE ) != 0 )
	{
		USBSERIF__UpdateAfterByteRxed( (uint8_t)(USART1->DR & 0xFF) );	// Byte received
	}
	else
	if ( ( ulRxStatus & USART_SR_TXE ) != 0 )
	{
		USBSERIF__UpdateAfterByteTxed();								// Transmit buffer empty
	}
	else
	{
		USBSERIF__UpdateAfterErrorDetected();							// Receiver error
	}

	return;
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief   UART5 Interrupt - Two-Wire Bus Comms Interface updated using the following function:
 *
 * 					- TWBCOMIF_UpdateTwoWireBusReceiverData()
 *
 * @param  	None.
 * @retval 	None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void		UART5_IRQHandler(void)
{
	uint32_t	ulRxStatus;
	uint8_t			ucRxByte;
	//
	// Get status and any byte received from the USART
	ulRxStatus = UART5->SR; ucRxByte = (uint8_t)(UART5->DR & 0xFF);
	// Check if any receiver error has occurred
	if ( ( ulRxStatus & USART_SR_RXNE ) != 0x00 )
	{
		TWBCOMIF__UpdateTwoWireBusReceiverData( false, ucRxByte );		// Byte received
	}
	else
	if ( ( ulRxStatus & ( USART_SR_FE | USART_SR_NE | USART_SR_ORE ) ) != 0 )
	{
		TWBCOMIF__UpdateTwoWireBusReceiverData( true, 0x00 );			// Error
	}

	return;
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief   This function handles the I2C1 event interrupts that are enabled.  All processing of I2C actions is done via the I2CCOMIF module.  The I2C is operated in simplified
 * 			mode so the only functions needed for processing are:
 *
 *				- I2CCOMIF_ActionAfterStartConditionGenerated().
 *				- I2CCOMIF_ActionAfterDeviceSelectByteTransmitted().
 *				- I2CCOMIF_ActionAfterDeviceDataByteTransferred().
 *
 * @param  	None.
 * @retval 	None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void		I2C1_EV_IRQHandler(void)
{
	uint16_t	uiSR1, uiSR2;

	uiSR1 = I2C1->SR1; uiSR2 = I2C1->SR2;

	if ( ( uiSR1 & I2C_SR1_SB ) != 0 )
	{
		I2CCOMIF__ActionAfterStartConditionGenerated();
	}
	else
	if ( ( uiSR1 & I2C_SR1_ADDR ) != 0 )
	{
		I2CCOMIF__ActionAfterDeviceSelectByteTransmitted();
	}
	else
	{
		I2CCOMIF__ActionAfterDeviceDataByteTransferred();
	}

	(void)uiSR1; (void)uiSR2;

	return;
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief   This function handles the I2C1 error interrupts that can occur.
 * @param  	None.
 * @retval 	None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void		I2C1_ER_IRQHandler(void)
{
	if ( ( I2C1->SR1 & I2C_SR1_AF ) != 0x00 )
	{
		I2C1->SR1 &= ~I2C_SR1_AF;	I2CCOMIF__ActionAfterBusErrorDetected();
	}
	else
	if ( ( I2C1->SR1 & I2C_SR1_BERR ) != 0x00 )
	{
		I2C1->SR1 &= ~I2C_SR1_BERR;	I2CCOMIF__ActionAfterBusErrorDetected();
	}
	else
	if ( ( I2C1->SR1 & I2C_SR1_OVR ) != 0x00 )
	{
		I2C1->SR1 &= ~I2C_SR1_OVR;	I2CCOMIF__ActionAfterBusErrorDetected();
	}
	else
	if ( ( I2C1->SR1 & I2C_SR1_ARLO ) != 0x00 )
	{
		I2C1->SR1 &= ~I2C_SR1_ARLO;	I2CCOMIF__ActionAfterBusErrorDetected();
	}

	return;
}
//********************************************************************************************************************************
