//*********************************************************************************************************************************************************************************
// mcuaxess_tempmsif.c
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * Release Information.
 *---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 *
 * Version:		N-C7  	   - v090
 * Date:		01/10/2020
 * Modifier:  	Emilio R. La Greca
 *
 * Original release.
 *
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

#include		<com_defn.h>
#include		<mcuaxess_def.h>

//*********************************************************************************************************************************************************************************
// MODULE
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// CONSTANTS
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// VARIABLES
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
static bool	mbADCalibrationDone = false;
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// SAVED VALUES
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// TIMING
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// FUNCTION DECLARES
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//*********************************************************************************************************************************************************************************


//*********************************************************************************************************************************************************************************
// APPLICATION
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// VARIABLES
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// FUNCTION DEFINITIONS
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:	This function switches power on/off to the thermistor measurement circuit.
 * @param:	voState	- The state (ON/OFF) to switch to the thermistor circuit.
 * @retval:	None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void							MCUAXESS_TEMPMSIF__SwitchOnOff(onoff voState)
{
	uint32_t	ulTempRegister;
	//
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// GPIOB.0 - Configure for Output PP mode @ 2MHz speed
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// - Get current state of CRL register
	ulTempRegister = GPIOB->CRL;
	// - Clear then set corresponding bits of temporary register
	ulTempRegister &= ~(GPIO_CRL_CNF0 | GPIO_CRL_MODE0); ulTempRegister |= GPIO_CRL_MODE0_1;
	// - Set current state of CRL register
	GPIOB->CRL = ulTempRegister;
	// - Update the state of the port pin
	if ( voState == on )
	{
		GPIOB->ODR |=  (uint32_t)GPIO_ODR_ODR0;
	}
	else
	{
		GPIOB->ODR &= ~(uint32_t)GPIO_ODR_ODR0;
	}

	return;
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:	This function configures the I/O and peripherals used to measure thermistor temperature via the on board AD converter.
 * @param:	vbCalibrateAD - Flag that indicates whether ot not to perform self calibration of the AD
 * @retval:	None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void							MCUAXESS_TEMPMSIF__EnableADC(bool vbCalibrateAD)
{
	uint32_t	ulTempRegister;
	//
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// 1) Switch power on to the thermistor
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	MCUAXESS_TEMPMSIF__SwitchOnOff( on );
	//
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// 2) ADC Clock Control
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// - ADC Clock Pre-scaler - ADCCLK = PCLK2/6 (6MHz with PCLK2 = 36MHz)
	RCC->CFGR &= ~RCC_CFGR_ADCPRE; RCC->CFGR |= RCC_CFGR_ADCPRE_DIV6;
	// - Enable clock to peripheral
	RCC->APB2ENR |= RCC_APB2ENR_ADC1EN;
	//
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// 3) GPIOB.1 Configuration - Analogue input
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// - Get current state of CRL register
	ulTempRegister = GPIOB->CRL;
	// - Clear then set corresponding bits of temporary register
	ulTempRegister &= ~(GPIO_CRL_CNF1 | GPIO_CRL_MODE1);
	// - Set current state of CRL register
	GPIOB->CRL = ulTempRegister;
	//
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// 4) ADC Configuration
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// - Channel09 Sampling @ 1.5 Cycles
	ADC1->SMPR2 &= ~ADC_SMPR2_SMP9;
	// - Scan channel09 once
	ADC1->SQR1 = 0; ADC1->SQR2 = 0; ADC1->SQR3 = 9;
	// - Clear control register 2
	ADC1->CR1 = 0;
	// - Switch ADON (Second call and onwards conversion will be started)
	ADC1->CR2 |= ADC_CR2_ADON;
	//
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// 5) Perform self calibration - Only once on powerup
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	if ( vbCalibrateAD )
	{
		ADC1->CR2 |= ADC_CR2_CAL;

		do
		{

		}
		while ( ( ADC1->CR2 & ADC_CR2_CAL ) == ADC_CR2_CAL );
	}

	mbADCalibrationDone = true;

	return;
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:	Returns flag indicating when AD calibration done.
 * @param:	None.
 * @retval:	bool.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
bool							MCUAXESS_TEMPMSIF__bADCalibrationDone(void)
{
	return mbADCalibrationDone;
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:	This function initiates an AD conversion to measure thermistor temperature returning the result as a 16 bit value.
 * @param:	None.
 * @retval:	The converted result of AD channel representing the thermistor temperature.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
uint16_t						MCUAXESS_TEMPMSIF__uiADCResult(void)
{
	// - Update configuration (starts conversion)
	MCUAXESS_TEMPMSIF__EnableADC( false );
	// - Wait for EOC bit to set
	do { } while ( ( ADC1->SR & ADC_SR_EOC ) == 0 );
	// - Conversion complete so reset EOC bit
	ADC1->SR &= ~ADC_SR_EOC;
	// - Form and return result
	return (uint16_t)( ADC1->DR & 0xFFFF );
}
//*********************************************************************************************************************************************************************************



