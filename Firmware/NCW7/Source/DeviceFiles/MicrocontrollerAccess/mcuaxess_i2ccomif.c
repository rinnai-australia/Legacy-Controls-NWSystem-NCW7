//*********************************************************************************************************************************************************************************
// mcuaxess_i2ccomif.c
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * Release Information.
 *---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 *
 * Version:		N-C7  	   - v090
 * Date:		01/10/2020
 * Modifier:  	Emilio R. La Greca
 *
 * Original release.
 *
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

#include		<com_defn.h>
#include		<mcuaxess_def.h>

//*********************************************************************************************************************************************************************************
// MODULE
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// CONSTANTS
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// VARIABLES
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// SAVED VALUES
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// TIMING
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// FUNCTION DECLARES
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//*********************************************************************************************************************************************************************************


//*********************************************************************************************************************************************************************************
// APPLICATION
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// VARIABLES
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// FUNCTION DEFINITIONS
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:	This function configures all I/O lines and peripherals used to interface the I2C bus of the control.
 * @param:	None.
 * @retval:	None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void							MCUAXESS_I2CCOMIF__Initialise(void)
{
	uint32_t	uiI2CClockSpeed = 200000;		// (200kHz - 10us lo/10us hi)
	uint32_t	ulTempRegister;
	uint16_t 	uiTempRegister, uiFreqRange;
	//
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// 1) Enable the peripheral clock - I2C1 (APB1)
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	RCC->APB1ENR |= RCC_APB1ENR_I2C1EN;
	//
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// 2) Update configuration of I/O used for SDA/SCL
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// a) SCL: GPIOB.6 (Configure for AF OD @50MHz)
	// - Get current state of CRL register
	ulTempRegister = GPIOB->CRL;
	// - Clear then set corresponding bits of temporary register
	ulTempRegister &= ~(GPIO_CRL_CNF6 | GPIO_CRL_MODE6); ulTempRegister |= (GPIO_CRL_CNF6_1 | GPIO_CRL_CNF6_0 | GPIO_CRL_MODE6_1 | GPIO_CRL_MODE6_0);
	// - Set current state of CRL register
	GPIOB->CRL = ulTempRegister;
	//
	// b) SDA: GPIOB.7 (Configure for AF OD @50MHz)
	// - Get current state of CRL register
	ulTempRegister = GPIOB->CRL;
	// - Clear then set corresponding bits of temporary register
	ulTempRegister &= ~(GPIO_CRL_CNF7 | GPIO_CRL_MODE7); ulTempRegister |= (GPIO_CRL_CNF7_1 | GPIO_CRL_CNF7_0 | GPIO_CRL_MODE7_1 | GPIO_CRL_MODE7_0);
	// - Set current state of CRL register
	GPIOB->CRL = ulTempRegister;
	//
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// 3) Configure the I2C1 peripheral
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// a) Reset & Disable Peripheral
	// - Reset the peripheral
	RCC->APB1RSTR |=  RCC_APB1RSTR_I2C1RST; RCC->APB1RSTR &= ~RCC_APB1RSTR_I2C1RST;
	// - Disable the peripheral
	I2C1->CR1 = 0;
	//
	// b) CR2 configuration update
	// - Get the I2Cx CR2 value
	uiTempRegister = I2C1->CR2;
	// - Clear frequency FREQ[5:0] bits
	uiTempRegister &= ~I2C_CR2_FREQ;
	// - Define frequency range
	uiFreqRange = (uint16_t)( PCLK1 / 1000000 );
	// - Set frequency bits depending on pclk1 value
	uiTempRegister |= uiFreqRange;
	// - Write to I2Cx CR2
	I2C1->CR2 = uiTempRegister;
	//
	// c) Clock configuration update
	// - Update clock control register
	I2C1->CCR   |= (uint16_t)( PCLK1 / uiI2CClockSpeed );
	// - Update T Rise register
	I2C1->TRISE |= (uint16_t)( uiFreqRange + 1 );
	//
	// d) Enable the peripheral
	// - Set PE
	I2C1->CR1 |= I2C_CR1_PE;
	// - Enable interrupts
	I2C1->CR2 |= (I2C_CR2_ITEVTEN | I2C_CR2_ITERREN);
	//
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// 4) Update NVIC Configuration
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// - EV Interrupt: Set priority level (0) and enable interrupt
	NVIC_SetPriority( I2C1_EV_IRQn, MCUAXESS_DEF__IP_I2C1_EV ); NVIC_EnableIRQ( I2C1_EV_IRQn );
	// - ER Interrupt: Set priority level (1) and enable interrupt
	NVIC_SetPriority( I2C1_ER_IRQn, MCUAXESS_DEF__IP_I2C1_ER ); NVIC_EnableIRQ( I2C1_ER_IRQn );

	return;
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:	This function switches off the I2C bus interface by disabling I2C1 and all associated interrupts.
 * @param:	None.
 * @retval:	None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void							MCUAXESS_I2CCOMIF__SwitchOffHardware(void)
{
	// Switch I2C1 and interrupts off
	I2C1->CR1 = 0; NVIC_DisableIRQ( I2C1_EV_IRQn ); NVIC_DisableIRQ( I2C1_ER_IRQn );
	// Disable the peripheral clock
	RCC->APB1ENR &= ~RCC_APB1ENR_I2C1EN;

	return;
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:	Sets the I2C start condition.
 * @param:	None.
 * @retval:	None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void							MCUAXESS_I2CCOMIF__SetStartCondition(void)
{
	I2C1->CR1 |= I2C_CR1_START;
	return;
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:	Sets the I2C stop condition.
 * @param:	None.
 * @retval:	None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void							MCUAXESS_I2CCOMIF__SetStopCondition(void)
{
	I2C1->CR1 |= I2C_CR1_STOP;
	return;
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:	Sets the I2C acknowledge condition.
 * @param:	None.
 * @retval:	None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void							MCUAXESS_I2CCOMIF__SetAcknowledge(void)
{
	I2C1->CR1 |= I2C_CR1_ACK;
	return;
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:	Clears the I2C start condition.
 * @param:	None.
 * @retval:	None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void							MCUAXESS_I2CCOMIF__ClrAcknowledge(void)
{
	I2C1->CR1 &= ~I2C_CR1_ACK;
	return;
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:	Transmits a byte over the I2C bus.
 * @param:	vucByte - The byte to transmit over the bus.
 * @retval:	None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void							MCUAXESS_I2CCOMIF__TxByte(uint8_t vucByte)
{
	I2C1->DR = vucByte;
	return;
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:	Receives a byte over the I2C bus.
 * @param:	None.
 * @retval:	The byte received.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
uint8_t							MCUAXESS_I2CCOMIF__ucByteRxed(void)
{
	return I2C1->DR;
}
//*********************************************************************************************************************************************************************************
