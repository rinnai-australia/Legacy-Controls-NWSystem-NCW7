//*********************************************************************************************************************************************************************************
// mcuaxess_twbcomif.c
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * Release Information.
 *---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 *
 * Version:		N-C7  	   - v090
 * Date:		01/10/2020
 * Modifier:  	Emilio R. La Greca
 *
 * Original release.
 *
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

#include		<com_defn.h>
#include		<mcuaxess_def.h>

//*********************************************************************************************************************************************************************************
// MODULE
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// CONSTANTS
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// VARIABLES
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
static uint16_t		muiTwoWireBusCounter;						// Counter for random seed generate
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// SAVED VALUES
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// TIMING
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// FUNCTION DECLARES
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//*********************************************************************************************************************************************************************************


//*********************************************************************************************************************************************************************************
// APPLICATION
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// VARIABLES
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// FUNCTION DEFINITIONS
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:	This function configures all I/O lines and peripherals used to interface the two-wire bus of the control.
 * @param:	vbDoFullInit - Do full init flag.
 * @retval:	None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
/*
void			MCUAXESS_TWBCOMIF__Initialise(void)
*/ // Pass Full Reset flag, NC7093
void			MCUAXESS_TWBCOMIF__Initialise(bool vbDoFullInit)
{
	/*
	static 	bool	sbConfigured = false;
	*/ // Use flag passed instead of static, NC7093

	uint32_t		ulTempRegister;
	//
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// 1) Enable the peripheral clock - USART5 (APB1)
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	RCC->APB1ENR |= RCC_APB1ENR_UART5EN;
	/*
	if (!sbConfigured)
	*/ // Use flag passed instead of static, NC7093
	if ( vbDoFullInit )
	{
		//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		// 2) Update configuration of I/O used for TX/RX
		//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		// a) TX: GPIOC.12 - Configure for AF PP @50MHz
		// - Get current state of CRH register
		ulTempRegister = GPIOC->CRH;
		// - Clear then set corresponding bits of temporary register
		ulTempRegister &= ~(GPIO_CRH_CNF12 | GPIO_CRH_MODE12); ulTempRegister |= (GPIO_CRH_CNF12_1 | GPIO_CRH_MODE12_1 | GPIO_CRH_MODE12_0);
		// - Set current state of CRH register
		GPIOC->CRH = ulTempRegister;
		//
		// b) RX: GPIOD.2 - Configure for input floating mode
		// - Get current state of CRH register
		ulTempRegister = GPIOD->CRL;
		// - Clear then set corresponding bits of temporary register
		ulTempRegister &= ~(GPIO_CRL_CNF2 | GPIO_CRL_MODE2); ulTempRegister |= GPIO_CRL_CNF2_0;
		// - Set current state of CRH register
		GPIOD->CRL = ulTempRegister;
		//
		//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		// 3) Update configuration of UART
		//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		// - Transmitter enabled
		// - Receiver enabled
		// - Generate interrupt whenever ORE=1 or RXNE=1 in status register
		//
		// - Format: 1 start bit, 8 data bits, 1 stop bit
		//   (USART_CR1_M = 0 in CR1 Register)
		//   (USART_CR2_STOP_0 & USART_CR2_STOP_1 = 0 in CR2 Register)
		//
		//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		// 4) Update baud rate register
		//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		//    BaudTxRx = fck / (16 x USARTDIV)	where fck = PCLK1	(PCLK1 = 36MHz)
		//
		//	  PCLK1 = 36MHz: For 9600Baud - USARTDIV = 36000000/(16x9600) = 234.375 *****This Frequency Used*****
		//	  234.375 equates to: M=234d (0xEA)
		//						  F=6d   (0x06)
		//
		// When not configured - First time
		// - Enable UART
		UART5->CR1 = USART_CR1_UE;
		UART5->CR2 = 0;
		UART5->CR3 = 0;
		// - Set Baud rate
		UART5->BRR = 0x0EA6;
		// - Enable Tx/Rx and interrupt
		UART5->CR1 |= (USART_CR1_RE | USART_CR1_TE | USART_CR1_RXNEIE);
	}
	//
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// 5) Update NVIC Configuration
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// - Set priority level and enable interrupt (Global)
	NVIC_SetPriority( UART5_IRQn, MCUAXESS_DEF__IP_UART5 ); NVIC_EnableIRQ( UART5_IRQn );
	//
	// Once configured for first flag to ensure only refresh occurs
	/*
	sbConfigured = true;
	*/ // Use flag passed instead of static, NC7093
	//
	// Update free running counter
	muiTwoWireBusCounter++;

	return;
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:	This function switches off the two-wire bus interface by disabling UART4 and all associated interrupts.
 * @param:	None.
 * @retval:	None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void							MCUAXESS_TWBCOMIF__SwitchOff(void)
{
	// Switch USART1 and interrupts off
	UART5->CR1 = 0; NVIC_DisableIRQ( UART5_IRQn );
	// Disable the peripheral clock
	RCC->APB1ENR &= ~RCC_APB1ENR_UART5EN;

	return;
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:	Functions to enable/disable the two-wire bus byte receiver interrupt.
 * @param:	None.
 * @retval:	None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void							MCUAXESS_TWBCOMIF__DisableReceiverInterrupt(void)
{
	NVIC_DisableIRQ( UART5_IRQn );
	return;
}
void							MCUAXESS_TWBCOMIF__EnableReceiverInterrupt(void)
{
	NVIC_EnableIRQ( UART5_IRQn );
	return;
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:	Functions to enable/disable the UART receiver used for TWB comms.
 * @param:	None.
 * @retval:	None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void							MCUAXESS_TWBCOMIF__DisableReceiver(void)
{
	UART5->CR1 &= ~USART_CR1_RE;
	return;
}
void							MCUAXESS_TWBCOMIF__EnableReceiver(void)
{
	UART5->CR1 |=  USART_CR1_RE;
	return;
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:	This function flushes the UART receiver used for TWB comms.
 * @param:	None.
 * @retval:	None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void							MCUAXESS_TWBCOMIF__FlushReceiver(void)
{
	uint8_t		ucDummyValue;

	while ( ( UART5->SR & USART_SR_RXNE ) != 0x00 )
	{
		ucDummyValue = (uint8_t)( UART5->DR & 0xFF );
	}

	(void)ucDummyValue;

	return;
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:	This function transmits a byte via the UART transmitter used for TWB comms.
 * @param:	vucByte - Byte to transmit.
 * @retval:	None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void							MCUAXESS_TWBCOMIF__TxByte(uint8_t vucByte)
{
	UART5->DR = (uint32_t)vucByte;
	return;
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:	Returns the value of the free running counter.
 * @param:	None.
 * @retval:	Free running counter value.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
uint16_t						MCUAXESS_TWBCOMIF__uiFreeRunningTimerCounterValue(void)
{
	return muiTwoWireBusCounter;
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:	Indicates whether or not the two-wire bus power supply is available.
 * @param:	None.
 * @retval:	bool.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
bool							MCUAXESS_TWBCOMIF__bBUSPowerDetected(void)
{
	uint32_t	ulTempRegister;
	//
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// GPIOC.7 - Configure for input mode
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// - Get current state of CRL register
	ulTempRegister = GPIOC->CRL;
	// - Clear then set corresponding bits of temporary register
	ulTempRegister &= ~(GPIO_CRL_CNF7 | GPIO_CRL_MODE7); ulTempRegister |= GPIO_CRL_CNF7_1;
	// - Set current state of CRH register
	GPIOC->CRL = ulTempRegister;
	// - Check state of input
	if ((GPIOC->IDR & (uint32_t)GPIO_IDR_IDR7) == 0) { return true;	} else { return false; }
}
//*********************************************************************************************************************************************************************************
