//*********************************************************************************************************************************************************************************
// mcuaxess_usbserif.c
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * Release Information.
 *---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 *
 * Version:		N-C7  	   - v090
 * Date:		01/10/2020
 * Modifier:  	Emilio R. La Greca
 *
 * Original release.
 *
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

#include		<com_defn.h>
#include		<mcuaxess_def.h>

//*********************************************************************************************************************************************************************************
// MODULE
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// CONSTANTS
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// VARIABLES
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// SAVED VALUES
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// TIMING
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// FUNCTION DECLARES
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//*********************************************************************************************************************************************************************************


//*********************************************************************************************************************************************************************************
// APPLICATION
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// VARIABLES
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// FUNCTION DEFINITIONS
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:	This function configures USART1 and associated I/O lines used to interface with the FT230X USB to serial onverter.
 * @param:	None.
 * @retval:	None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void							MCUAXESS_USBSERIF__Initialise(void)
{
	uint32_t	ulTempRegister;
	//
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// 1) Enable the peripheral clock - USART1 (APB2)
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	RCC->APB2ENR |= RCC_APB2ENR_USART1EN;
	//
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// 2) Update configuration of I/O used for TX/RX
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// a) TX: GPIOA.9 - Configure for AF PP @50MHz
	// - Get current state of CRH register
	ulTempRegister = GPIOA->CRH;
	// - Clear then set corresponding bits of temporary register
	ulTempRegister &= ~(GPIO_CRH_CNF9 | GPIO_CRH_MODE9); ulTempRegister |= (GPIO_CRH_CNF9_1 | GPIO_CRH_MODE9_1 | GPIO_CRH_MODE9_0);
	// - Set current state of CRH register
	GPIOA->CRH = ulTempRegister;
	//
	// b) RX: GPIOA.10 - Configure for input floating mode
	// - Get current state of CRH register
	ulTempRegister = GPIOA->CRH;
	// - Clear then set corresponding bits of temporary register
	ulTempRegister &= ~(GPIO_CRH_CNF10 | GPIO_CRH_MODE10); ulTempRegister |= GPIO_CRH_CNF10_0;
	// - Set current state of CRH register
	GPIOA->CRH = ulTempRegister;
	//
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// 3) Update configuration of UART
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// - Transmitter enabled
	// - Receiver enabled
	// - Generate interrupt whenever ORE=1 or RXNE=1 in status register
	//
	// - Format: 1 start bit, 8 data bits, 1 stop bit
	//   (USART_CR1_M = 0 in CR1 Register)
	//   (USART_CR2_STOP_0 & USART_CR2_STOP_1 = 0 in CR2 Register)
	USART1->CR1 = (USART_CR1_UE | USART_CR1_RE | USART_CR1_TE | USART_CR1_RXNEIE );
	USART1->CR2 = 0;
	USART1->CR3 = 0;
	//
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// 4) Update baud rate register
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	//    BaudTxRx = fck / (16 x USARTDIV)	where fck = PCLK2	(PCLK2 = 72MHz)
	//
	//	  PCLK2 = 72MHz: For 115200Baud - USARTDIV = 72000000/(16x115200) = 117.1875 *****This Frequency Used*****
	//	  30.0625 equates to: M=39d (0x27)
	//						  F=1d  (0x01)
	//
	USART1->BRR = 0x0271;		// 115200	: 39.0625	- 0x271
	//
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// 5) Update NVIC Configuration
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// - Set priority level and enable interrupt (Global)
	NVIC_SetPriority( USART1_IRQn, MCUAXESS_DEF__IP_USART1 ); NVIC_EnableIRQ( USART1_IRQn );

	return;
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:	This function disables the UART receiver used for USB comms.
 * @param:	None.
 * @retval:	None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void							MCUAXESS_USBSERIF__DisableReceiver(void)
{
	USART1->CR1 &= ~USART_CR1_RE;
	return;
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:	This function enables the UART receiver used for USB comms.
 * @param:	None.
 * @retval:	None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void							MCUAXESS_USBSERIF__EnableReceiver(void)
{
	USART1->CR1 |=  USART_CR1_RE;
	return;
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:	This function flushes the UART receiver used for USB comms.
 * @param:	None.
 * @retval:	None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void							MCUAXESS_USBSERIF__FlushReceiverBuffer(void)
{
	uint8_t		ucDummyValue;

	while ( ( USART1->SR & USART_SR_RXNE ) != 0x00 )
	{
		ucDummyValue = (uint8_t)( USART1->DR & 0xFF );
	}

	(void)ucDummyValue;

	return;
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:	This function transmits a byte via the UART transmitter used for USB comms.
 * @param:	vucByte - Byte to transmit.
 * @retval:	None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void							MCUAXESS_USBSERIF__TxByte(uint8_t vucByte)
{
	USART1->DR = (uint32_t)vucByte;
	return;
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:	This function enables the USART1 interrupt that indicates when the UART transmit register is empty.
 * @param:	vucByte - Byte to transmit.
 * @retval:	None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void							MCUAXESS_USBSERIF__EnableTxInt(void)
{
	USART1->CR1 |=  USART_CR1_TXEIE;
	return;
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:	This function disables the USART1 interrupt that indicates when the transmit register is empty.
 * @param:	None.
 * @retval:	None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void							MCUAXESS_USBSERIF__DisableTxInt(void)
{
	USART1->CR1 &= ~USART_CR1_TXEIE;
	return;
}
//*********************************************************************************************************************************************************************************


