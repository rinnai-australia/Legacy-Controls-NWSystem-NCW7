//*********************************************************************************************************************************************************************************
// mcuaxess_rtmclkif.c
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * Release Information.
 *---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 *
 * Version:		N-C7  	   - v090
 * Date:		01/10/2020
 * Modifier:  	Emilio R. La Greca
 *
 * Original release.
 *
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

#include		<com_defn.h>
#include		<mcuaxess_def.h>

//*********************************************************************************************************************************************************************************
// MODULE
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// CONSTANTS
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// VARIABLES
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// SAVED VALUES
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// TIMING
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// FUNCTION DECLARES
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
static void						WaitForRTCAccessAllowed(void);
//*********************************************************************************************************************************************************************************


//*********************************************************************************************************************************************************************************
// APPLICATION
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// VARIABLES
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// FUNCTION DEFINITIONS
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:	This function configures the RTC peripheral for real time clock keeping if it is detected to have failed due to power loss on the Vbat pin.  If the RTC has failed true
 * 			is returned to indicate this.
 * @param:	None.
 * @retval:	A bool flag indicating whether or not RTC failure was detected.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
bool							MCUAXESS_RTMCLKIF__bRTCFailureDetectedOnConfigurationUpdate(void)
{
	bool		bRTCFailureDetected;
	//
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// 1) Enable RTC & backup register access
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// - Enable the power and backup interface clocks
	RCC->APB1ENR |= (RCC_APB1ENR_PWREN | RCC_APB1ENR_BKPEN);
	// - Enable access to the Backup registers and RTC
	PWR->CR		 |= PWR_CR_DBP;
	//
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// 2) RTC Configuration
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// Check RTCEN bit for RTC enabled
	if ( ( RCC->BDCR & RCC_BDCR_RTCEN ) != 0 )
	{
		// Yes, RTC enabled so wait for register synchronisation to complete
		// - Clear RSF flag
		RTC->CRL &= (uint16_t)~RTC_FLAG_RSF;
		// - Loop until RSF flag is set
		do { } while ( ( RTC->CRL & RTC_FLAG_RSF ) == 0 );
		// - RTC enable bit still set so RTC okay
		bRTCFailureDetected = false;
	}
	else
	{
		// No, RTC not enabled so configuration required
		// a) Update Backup Domain Control Register (RCC_BDCR)
		// - Switch LSE on			: LSEON
		RCC->BDCR |= RCC_BDCR_LSEON;
		// - Wait for LSE to be ready
		do { } while ( ( RCC->BDCR & RCC_BDCR_LSERDY ) == 0 );
		// - Clock source is LSE	: LSE
		RCC->BDCR |= RCC_BDCR_RTCSEL_LSE;
		// - Enable RTC				: RTCEN
		RCC->BDCR |= RCC_BDCR_RTCEN;
		// - Wait for register synchronisation to complete
		do { } while ( ( RTC->CRL & RTC_FLAG_RSF ) == 0 );
		//
		// b) Configure RTC registers accordingly
		// - Wait for RTC register access
		WaitForRTCAccessAllowed();
		// - Enter RTC config mode
		RTC->CRL |=  RTC_CRL_CNF;
		// - Define prescaler value (32768Hz Clock on LSE)
		RTC->PRLH = 0x0000; RTC->PRLL = 0x7FFF;
		// - Exit RTC config mode
		RTC->CRL &= ~RTC_CRL_CNF;
		// - Wait for access allowed before proceeding
		WaitForRTCAccessAllowed();
		//
		// Flag for function return
		bRTCFailureDetected = true;
	}
	//
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// 3) Interrupt Control
	//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	// - Enable RTC seconds interrupt
	RTC->CRH |= RTC_CRH_SECIE;
	// - Set priority level and enable interrupt (Global)
	NVIC_SetPriority( RTC_IRQn, MCUAXESS_DEF__IP_RTC_SECI ); NVIC_EnableIRQ( RTC_IRQn );

	return bRTCFailureDetected;
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:	This function returns the counter value used for RTC time keeping.
 * @param:	None.
 * @retval:	The 32-bit value representing the RTC time keepin couter value.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
uint32_t						MCUAXESS_RTMCLKIF__ulRTCCounterRegister(void)
{
	uint16_t	uiTemp = 0;

	uiTemp = RTC->CNTL;

	return ( ( (uint32_t)RTC->CNTH << 16 ) | uiTemp );
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:	This function sets the counter value used for RTC time keeping with the value passed.
 * @param:	vulNewCounterValue - The new value to be loaded into the counter used for RTC time keeping.
 * @retval:	None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void							MCUAXESS_RTMCLKIF__SetRTCCounterRegister(uint32_t vulNewCounterValue)
{
	// - Wait until access to RTC allowed
	WaitForRTCAccessAllowed();
	// - Enter RTC config mode
	RTC->CRL |=  RTC_CRL_CNF;
	// - Set counter MSB word
    RTC->CNTH = (uint16_t)( vulNewCounterValue >> 16 );
	// - Set counter LSB word
    RTC->CNTL = (uint16_t)( vulNewCounterValue & RTC_CNTL_RTC_CNT );
	// - Exit RTC config mode
	RTC->CRL &= ~RTC_CRL_CNF;
	// - Wait for access allowed before proceeding
	WaitForRTCAccessAllowed();

	return;
}
//*********************************************************************************************************************************************************************************


//*********************************************************************************************************************************************************************************
// MODULE FUNCTION DEFINITIONS
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:  Loops continuously until the RTOFF flag of the RTC control register is set at which point RTC write access is allowed.
 * @param:  None.
 * @retval: None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
static void						WaitForRTCAccessAllowed(void)
{
	// Loop until RTOFF flag is set - Must check before any RTC write
	do
	{
	}
	while ( ( RTC->CRL & RTC_FLAG_RTOFF ) == 0 );

	return;
}
//*********************************************************************************************************************************************************************************
