//*********************************************************************************************************************************************************************************
// switchif.c
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * Release Information.
 *---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 *
 * Version:		N-C7  	   - v090
 * Date:		01/10/2020
 * Modifier:  	Emilio R. La Greca
 *
 * Original release.
 *
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

#include		<com_defn.h>
#include		<gentimdt.h>
#include		<mcuaxess.h>

//*********************************************************************************************************************************************************************************
// MODULE
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// CONSTANTS
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
typedef enum	SWITCHIF__SW_TOGGLE_STATE {

	SWITCHIF__STS__INIT     = 0,
	SWITCHIF__STS__MONITOR  = 1,
	SWITCHIF__STS__DEBOUNCE = 2,
	SWITCHIF__STS__DETECTED = 3,
 	SWITCHIF__STS__IDLE     = 4,

} SWITCHIF__SW_TOGGLE_STATE;
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// VARIABLES
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
typedef struct	Switch1Details {							// Switch 1 Details
															//
	GENTIMDT__TimingCounter		DebounceTimeCounter;		// - Switch debounce time counter
															//
} Switch1Details;											//
															//
static Switch1Details	mSwitch1;							// Container
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// SAVED VALUES
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// TIMING
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
const struct	GENTIMDT__Timing	SWITCHIF__kSW1DebounceTiming = { &mSwitch1.DebounceTimeCounter };
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// FUNCTION DECLARES
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//*********************************************************************************************************************************************************************************


//*********************************************************************************************************************************************************************************
// APPLICATION
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// VARIABLES
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// FUNCTION DEFINITIONS
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:	This function indicates whether SW1 is being toggled or not.
 * @param:	None.
 * @retval:	bool.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
bool							SWITCHIF__bSW1BeingToggled(void)
{
	static SWITCHIF__SW_TOGGLE_STATE 	sSwitchToggleState = SWITCHIF__STS__INIT;
	static onoff						soLastSwitchState;

	switch ( sSwitchToggleState )
	{
		case SWITCHIF__STS__INIT:
			// By time this fcn called switch level has had time to stabilize - Set state of switch
			soLastSwitchState = MCUAXESS__oSW1State();

			sSwitchToggleState = SWITCHIF__STS__MONITOR;
			break;

		case SWITCHIF__STS__MONITOR:
			// Monitor for a change in state of the switch
			if ( MCUAXESS__oSW1State() == soLastSwitchState ) { break; }
			//
			// Switch state changed - Start debounce time
			GENTIMDT__StartTimer_TB_1SEC( 1, &mSwitch1.DebounceTimeCounter );

			sSwitchToggleState = SWITCHIF__STS__DEBOUNCE;
			break;

		case SWITCHIF__STS__DEBOUNCE:
			if ( mSwitch1.DebounceTimeCounter.ulValue != 0 ) { break; }
			//
			// Debounce time up - Check state of switch
			if ( MCUAXESS__oSW1State() == soLastSwitchState )
			{
				sSwitchToggleState = SWITCHIF__STS__MONITOR;	// After debounce state has not changed so monitor
			}
			else
			{
				sSwitchToggleState = SWITCHIF__STS__DETECTED;	// After debounce state changed so reset needed
			}
			break;

		default:
			// No action as restart invoked
			break;
	}

	if ( sSwitchToggleState == SWITCHIF__STS__DETECTED )
	{
		sSwitchToggleState = SWITCHIF__STS__IDLE;

		return true;
	}
	else
	{
		return false;
	}
}
//*********************************************************************************************************************************************************************************
