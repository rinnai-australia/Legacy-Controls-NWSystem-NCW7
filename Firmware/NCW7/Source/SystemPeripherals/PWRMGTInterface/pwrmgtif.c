//*********************************************************************************************************************************************************************************
// pwrmgtif.c
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * Release Information.
 *---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 *
 * Version:		N-C7  	   - v090
 * Date:		01/10/2020
 * Modifier:  	Emilio R. La Greca
 *
 * Original release.
 *
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

#include		<com_defn.h>
#include		<mcuaxess.h>

//*********************************************************************************************************************************************************************************
// MODULE
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// CONSTANTS
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#define			PWRMGTIF__VOLTAGE_CHECK_SAMPLE_TIME_1MS		10
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// VARIABLES
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
typedef struct	PowerSupplyDetails {				// Power Supply Checking Details
													//
	uint8_t		ucSampleTimex1ms;					// - Time to sample inputs
													//
	bool		bVoltageStabilized;					// - Voltage supply stabilized flag
	bool		bCheckInputs;						// - When to check inputs (at the sample rate)
	bool		bEXTActive;							// - System is being externally powered
													//
	bool		bOperateInLowPowerMode;				// - Flag indicating low power (usb) mode
													//
} PowerSupplyDetails;								//
													//
static PowerSupplyDetails	mPowerSupply;			// Container
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// SAVED VALUES
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// TIMING
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// FUNCTION DECLARES
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//*********************************************************************************************************************************************************************************


//*********************************************************************************************************************************************************************************
// APPLICATION
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// VARIABLES
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// FUNCTION DEFINITIONS
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:	Initialises the power management interface.
 * @param:	None.
 * @retval:	None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void							PWRMGTIF__Initialise(void)
{
	mPowerSupply.ucSampleTimex1ms   = PWRMGTIF__VOLTAGE_CHECK_SAMPLE_TIME_1MS;
	mPowerSupply.bCheckInputs       = false;
	mPowerSupply.bVoltageStabilized	= false;

	mPowerSupply.bOperateInLowPowerMode = true;

	return;
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:	Updates the power management interface - Main loop.
 * @param:	None.
 * @retval:	None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void							PWRMGTIF__Update(void)
{
	bool		bEXTPower;

	if ( !mPowerSupply.bCheckInputs ) { return; }

	if ( !mPowerSupply.bVoltageStabilized )
	{
		// Update power control flags
		// - EXT powered
		mPowerSupply.bEXTActive = MCUAXESS__b12VPowerDetected();
	}
	else
	{
		// Update power control flags
		// - EXT powered
		bEXTPower = MCUAXESS__b12VPowerDetected();
		//
		// Check if switching from EXT to USB power
		if ( ( mPowerSupply.bEXTActive ) && ( !bEXTPower ) )
		{
			// Was powered from EXT - Force RESET
			MCUAXESS__ResetMicrocontroller();
		}
		else
		if ( ( !mPowerSupply.bEXTActive ) && ( bEXTPower ) )
		{
			// Was powered from USB - Force RESET
			MCUAXESS__ResetMicrocontroller();
		}
		else
		{
			// Update power control flags
			// - EXT powered
			mPowerSupply.bEXTActive = bEXTPower;
		}
	}
	//
	// Define action to take
	if ( mPowerSupply.bEXTActive )
	{
		MCUAXESS__Connect5VUSB( off );							// Power supply from external source
																// - Disconnect 5V USB from 5V supply
		mPowerSupply.bOperateInLowPowerMode = false;
	}
	else
	{
		MCUAXESS__Connect5VUSB( on );							// Power supply must be from USB
																// - Connect 5V USB to 5V supply
		mPowerSupply.bOperateInLowPowerMode = true;
	}

	mPowerSupply.bVoltageStabilized = true;

	return;
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:	Updates the power management interface - 1ms timebase.
 * @param:	None.
 * @retval:	None.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
void							PWRMGTIF__Update01ms(void)
{
	if ( mPowerSupply.ucSampleTimex1ms != 0 )
	{
		mPowerSupply.ucSampleTimex1ms--;
	}

	if ( mPowerSupply.ucSampleTimex1ms == 0 )
	{
		mPowerSupply.ucSampleTimex1ms = PWRMGTIF__VOLTAGE_CHECK_SAMPLE_TIME_1MS;
		mPowerSupply.bCheckInputs     = true;
	}

	return;
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:	Indicates if power supply voltage has stabilized.
 * @param:	None.
 * @retval:	bool.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
bool							PWRMGTIF__bPowerSupplyVoltageStabilized(void)
{
	return mPowerSupply.bVoltageStabilized;
}
/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 * @brief:	Indicates if operating in low-power mode.
 * @param:	None.
 * @retval:	bool.
 *-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
bool							PWRMGTIF__bOperateInLowPowerMode(void)
{
	return mPowerSupply.bOperateInLowPowerMode;
}
//*********************************************************************************************************************************************************************************
